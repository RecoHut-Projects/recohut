---

title: STOSA


keywords: fastai
sidebar: home_sidebar

summary: "Stochastic Self-Attention model for Sequential Item Recommendation."
description: "Stochastic Self-Attention model for Sequential Item Recommendation."
nb_path: "nbs/models/models.stosa.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/models/models.stosa.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="STOSA" class="doc_header"><code>class</code> <code>STOSA</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/models/stosa.py#L23" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>STOSA</code>(<strong><code>item_size</code></strong>, <strong><code>num_users</code></strong>, <strong><code>hidden_size</code></strong>, <strong><code>max_seq_length</code></strong>, <strong><code>num_attention_heads</code></strong>, <strong><code>optimizer</code></strong>=<em><code>'adamw'</code></em>, <strong><code>learning_rate</code></strong>=<em><code>0.003</code></em>, <strong><code>hidden_dropout_prob</code></strong>=<em><code>0.2</code></em>, <strong><code>attention_probs_dropout_prob</code></strong>=<em><code>0.2</code></em>, <strong><code>num_hidden_layers</code></strong>=<em><code>2</code></em>, <strong><code>distance_metric</code></strong>=<em><code>'wasserstein'</code></em>, <strong><code>initializer_range</code></strong>=<em><code>0.02</code></em>, <strong><code>pvn_weight</code></strong>=<em><code>0.1</code></em>, <strong><code>kernel_param</code></strong>=<em><code>1.0</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>LightningModule</code></p>
</blockquote>
<p>Hooks to be used in LightningModule.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="STOSAMean" class="doc_header"><code>class</code> <code>STOSAMean</code><a href="https://github.com/RecoHut-Projects/recohut/tree/master/recohut/models/stosa.py#L468" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>STOSAMean</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/recohut/models.stosa.html#STOSA"><code>STOSA</code></a></p>
</blockquote>
<p>Hooks to be used in LightningModule.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Tests</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">item_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_users</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">max_seq_length</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">hidden_dropout_prob</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">initializer_range</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">num_hidden_layers</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">attention_probs_dropout_prob</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">num_attention_heads</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;wasserstein&#39;</span>
<span class="n">initializer_range</span> <span class="o">=</span> <span class="mf">0.02</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;adamw&#39;</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.003</span>
<span class="n">pvn_weight</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">kernel_param</span><span class="o">=</span><span class="mf">1.0</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">STOSA</span><span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="p">,</span> <span class="n">num_attention_heads</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span>
              <span class="n">hidden_dropout_prob</span><span class="p">,</span> <span class="n">attention_probs_dropout_prob</span><span class="p">,</span> <span class="n">num_hidden_layers</span><span class="p">,</span>
              <span class="n">distance_metric</span><span class="p">,</span> <span class="n">initializer_range</span><span class="p">,</span> <span class="n">pvn_weight</span><span class="p">,</span> <span class="n">kernel_param</span><span class="p">)</span>

<span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
<span class="n">user_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">user_ids</span><span class="p">)</span>
<span class="n">output_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">]]</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">STOSAMean</span><span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">,</span> <span class="n">max_seq_length</span><span class="p">,</span> <span class="n">num_attention_heads</span><span class="p">,</span>
                  <span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span>
                  <span class="n">hidden_dropout_prob</span><span class="p">,</span> <span class="n">attention_probs_dropout_prob</span><span class="p">,</span> <span class="n">num_hidden_layers</span><span class="p">,</span>
                  <span class="n">distance_metric</span><span class="p">,</span> <span class="n">initializer_range</span><span class="p">,</span> <span class="n">pvn_weight</span><span class="p">,</span> <span class="n">kernel_param</span><span class="p">)</span>

<span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>
<span class="n">user_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">item_size</span><span class="p">,</span> <span class="n">hidden_size</span><span class="p">))</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">user_ids</span><span class="p">)</span>
<span class="n">output_shapes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">]]</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">output_shapes</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Example</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/data&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_seq_length</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_seq_length</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_frac</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/recommender_logs&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dir</span> <span class="o">=</span> <span class="s1">&#39;/content/recommender_models&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val_epoch</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="s1">&#39;valid_loss&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">item_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_size</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden_dropout_prob</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initializer_range</span> <span class="o">=</span> <span class="mf">0.02</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_probs_dropout_prob</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_attention_heads</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;wasserstein&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s1">&#39;adamw&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvn_weight</span><span class="o">=</span><span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_param</span><span class="o">=</span><span class="mf">1.0</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">recohut.datasets.amazon_beauty</span> <span class="kn">import</span> <span class="n">AmazonBeautyDataModule</span>

<span class="n">dm</span> <span class="o">=</span> <span class="n">AmazonBeautyDataModule</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
<span class="n">dm</span><span class="o">.</span><span class="n">prepare_data</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Processing...
Done!
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">args</span><span class="o">.</span><span class="n">item_size</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item_size</span>
<span class="n">args</span><span class="o">.</span><span class="n">num_users</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num_users</span>
<span class="n">args</span><span class="o">.</span><span class="n">valid_matrix</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">valid_rating_matrix</span>
<span class="n">args</span><span class="o">.</span><span class="n">test_matrix</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">test_rating_matrix</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">STOSA</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">TensorBoardLogger</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks.early_stopping</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>

<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;STOSA&#39;</span><span class="p">)</span>
<span class="n">earlystop_callback</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;valid_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
                  <span class="n">check_val_every_n_epoch</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">val_epoch</span><span class="p">,</span>
                  <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span> 
                  <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">,</span> <span class="n">earlystop_callback</span><span class="p">],</span>
                  <span class="n">gpus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>GPU available: False, used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs

  | Name                     | Type          | Params
-----------------------------------------------------------
0 | item_mean_embeddings     | Embedding     | 356 K 
1 | item_cov_embeddings      | Embedding     | 356 K 
2 | position_mean_embeddings | Embedding     | 12.8 K
3 | position_cov_embeddings  | Embedding     | 12.8 K
4 | user_margins             | Embedding     | 484   
5 | item_encoder             | DistSAEncoder | 199 K 
6 | layernorm                | LayerNorm     | 128   
7 | dropout                  | Dropout       | 0     
-----------------------------------------------------------
939 K     Trainable params
0         Non-trainable params
939 K     Total params
3.756     Total estimated model params size (MB)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--------------------------------------------------------------------------------
DATALOADER:0 TEST RESULTS
{&#39;test_auc&#39;: 0.525363028049469,
 &#39;test_loss&#39;: 0.6991119384765625,
 &#39;test_pvn_loss&#39;: 4.98726224899292,
 &#39;test_scores&#39;: {&#39;HIT@1&#39;: tensor(0.),
                 &#39;HIT@10&#39;: tensor(0.),
                 &#39;HIT@15&#39;: tensor(0.),
                 &#39;HIT@20&#39;: tensor(0.),
                 &#39;HIT@40&#39;: tensor(0.0041),
                 &#39;HIT@5&#39;: tensor(0.),
                 &#39;MRR&#39;: tensor(0.0001, dtype=torch.float64),
                 &#39;NDCG@1&#39;: tensor(0.0041),
                 &#39;NDCG@10&#39;: tensor(0.0041),
                 &#39;NDCG@15&#39;: tensor(0.0041),
                 &#39;NDCG@20&#39;: tensor(0.0041),
                 &#39;NDCG@40&#39;: tensor(0.0041),
                 &#39;NDCG@5&#39;: tensor(0.0041)}}
--------------------------------------------------------------------------------
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;test_auc&#39;: 0.525363028049469,
  &#39;test_loss&#39;: 0.6991119384765625,
  &#39;test_pvn_loss&#39;: 4.98726224899292,
  &#39;test_scores&#39;: {&#39;HIT@1&#39;: tensor(0.),
   &#39;HIT@10&#39;: tensor(0.),
   &#39;HIT@15&#39;: tensor(0.),
   &#39;HIT@20&#39;: tensor(0.),
   &#39;HIT@40&#39;: tensor(0.0041),
   &#39;HIT@5&#39;: tensor(0.),
   &#39;MRR&#39;: tensor(0.0001, dtype=torch.float64),
   &#39;NDCG@1&#39;: tensor(0.0041),
   &#39;NDCG@10&#39;: tensor(0.0041),
   &#39;NDCG@15&#39;: tensor(0.0041),
   &#39;NDCG@20&#39;: tensor(0.0041),
   &#39;NDCG@40&#39;: tensor(0.0041),
   &#39;NDCG@5&#39;: tensor(0.0041)}}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">STOSAMean</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pytorch_lightning</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.loggers</span> <span class="kn">import</span> <span class="n">TensorBoardLogger</span>
<span class="kn">from</span> <span class="nn">pytorch_lightning.callbacks.early_stopping</span> <span class="kn">import</span> <span class="n">EarlyStopping</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">TensorBoardLogger</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>

<span class="n">checkpoint_callback</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s1">&#39;valid_loss&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">model_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;STOSA&#39;</span><span class="p">)</span>
<span class="n">earlystop_callback</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;valid_loss&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                  <span class="n">check_val_every_n_epoch</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
                  <span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="p">,</span> 
                  <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint_callback</span><span class="p">,</span> <span class="n">earlystop_callback</span><span class="p">],</span>
                  <span class="n">gpus</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>GPU available: False, used: False
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
Missing logger folder: /content/recommender_logs/default

  | Name                     | Type              | Params
---------------------------------------------------------------
0 | item_mean_embeddings     | Embedding         | 356 K 
1 | item_cov_embeddings      | Embedding         | 356 K 
2 | position_mean_embeddings | Embedding         | 12.8 K
3 | position_cov_embeddings  | Embedding         | 12.8 K
4 | user_margins             | Embedding         | 484   
5 | item_encoder             | DistMeanSAEncoder | 199 K 
6 | layernorm                | LayerNorm         | 128   
7 | dropout                  | Dropout           | 0     
---------------------------------------------------------------
939 K     Trainable params
0         Non-trainable params
939 K     Total params
3.756     Total estimated model params size (MB)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">dm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>--------------------------------------------------------------------------------
DATALOADER:0 TEST RESULTS
{&#39;test_auc&#39;: 0.5465450286865234,
 &#39;test_loss&#39;: 0.6889303922653198,
 &#39;test_pvn_loss&#39;: 4.940025806427002,
 &#39;test_scores&#39;: {&#39;HIT@1&#39;: tensor(0.),
                 &#39;HIT@10&#39;: tensor(0.),
                 &#39;HIT@20&#39;: tensor(0.),
                 &#39;HIT@40&#39;: tensor(0.),
                 &#39;HIT@5&#39;: tensor(0.),
                 &#39;MRR&#39;: tensor(0.),
                 &#39;NDCG@1&#39;: tensor(0.),
                 &#39;NDCG@10&#39;: tensor(0.),
                 &#39;NDCG@20&#39;: tensor(0.),
                 &#39;NDCG@40&#39;: tensor(0.),
                 &#39;NDCG@5&#39;: tensor(0.)}}
--------------------------------------------------------------------------------
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[{&#39;test_auc&#39;: 0.5465450286865234,
  &#39;test_loss&#39;: 0.6889303922653198,
  &#39;test_pvn_loss&#39;: 4.940025806427002,
  &#39;test_scores&#39;: {&#39;HIT@1&#39;: tensor(0.),
   &#39;HIT@10&#39;: tensor(0.),
   &#39;HIT@20&#39;: tensor(0.),
   &#39;HIT@40&#39;: tensor(0.),
   &#39;HIT@5&#39;: tensor(0.),
   &#39;MRR&#39;: tensor(0.),
   &#39;NDCG@1&#39;: tensor(0.),
   &#39;NDCG@10&#39;: tensor(0.),
   &#39;NDCG@20&#39;: tensor(0.),
   &#39;NDCG@40&#39;: tensor(0.),
   &#39;NDCG@5&#39;: tensor(0.)}}]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

